<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Level Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #222;
            color: white;
            -webkit-user-select: none;
            user-select: none;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-sizing: border-box;
            padding: 20px;
        }
        .hidden {
            display: none !important;
        }
        button {
            padding: 12px 20px;
            font-size: 18px;
            cursor: pointer;
            background: #555;
            color: white;
            border: 2px solid white;
            margin: 10px;
            border-radius: 0;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background: #777;
        }
        button:active {
            background: #444;
        }
        canvas {
            border: 2px solid white;
            background: #333;
            flex-shrink: 0;
        }
        #game-screen canvas {
            cursor: default;
        }
        #game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('assets/game-over.gif');
            background-size: cover;
            background-position: center;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #cookie-consent-text {
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        #cookie-consent-text a {
            color: #00aaff;
        }
    </style>
</head>
<body>

    <div id="cookie-consent-screen" class="screen">
        <h1>We Use Cookies</h1>
        <div id="cookie-consent-text">
            <p>This website uses cookies to enhance your experience. By clicking "Agree", you agree to our use of cookies.</p>
        </div>
        <button id="acceptBtn">Agree</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <p>Controls: A/D to move, Space to jump</p>
    </div>

    <div id="game-over-overlay" class="screen hidden"></div>

    <script>
        const CONSENT_KEY = 'cookieConsentGiven';

        const consentScreen = document.getElementById('cookie-consent-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const acceptBtn = document.getElementById('acceptBtn');

        let animationId;
        let currentLevel = {};
        let isGameOver = false;
        let camera = { x: 0, y: 0 };
        let levelWidth = 3000; // Ширина уровня для длинной карты

        // Звук проигрыша
        const gameOverSound = new Audio('assets/game-over-sound.mp3');

        // Функция для показа экрана
        function showScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
        }

        // Проверяем, было ли получено согласие на cookies
        if (localStorage.getItem(CONSENT_KEY) !== 'true') {
            showScreen(consentScreen);
        } else {
            showScreen(gameScreen);
            startGame();
        }

        // Обработчик нажатия на кнопку согласия
        acceptBtn.addEventListener('click', () => {
            localStorage.setItem(CONSENT_KEY, 'true');
            showScreen(gameScreen);
            startGame();
        });

        // Функция генерации случайного уровня
        function generateRandomLevel() {
            const level = {
                name: "Random Level",
                cubes: [],
                deathCubes: [],
                movingCubes: [],
                winPortal: null
            };

            // Создаем начальную платформу
            level.cubes.push({ x: 0, y: 350, width: 200, height: 50 });

            // Генерируем платформы, блоки смерти и движущиеся платформы
            let lastX = 200;
            let lastY = 350;
            
            while (lastX < levelWidth - 300) {
                // Случайное расстояние до следующей платформы
                const distance = Math.random() * 150 + 100;
                const newX = lastX + distance;
                
                // Случайная высота платформы
                const heightDiff = (Math.random() - 0.5) * 150;
                const newY = Math.max(150, Math.min(350, lastY + heightDiff));
                
                // Случайная ширина платформы
                const width = Math.random() * 100 + 80;
                
                // Добавляем платформу
                level.cubes.push({ x: newX, y: newY, width: width, height: 20 });
                
                // С вероятностью 30% добавляем блок смерти на платформу
                if (Math.random() < 0.3) {
                    level.deathCubes.push({ 
                        x: newX + width/2 - 20, 
                        y: newY - 40, 
                        width: 40, 
                        height: 40 
                    });
                }
                
                // С вероятностью 20% добавляем движущуюся платформу
                if (Math.random() < 0.2) {
                    const movingWidth = Math.random() * 50 + 50;
                    level.movingCubes.push({
                        x: newX,
                        y: newY - 50,
                        width: movingWidth,
                        height: 20,
                        speed: Math.random() * 2 + 1,
                        range: Math.random() * 100 + 50,
                        direction: 1,
                        initialX: newX
                    });
                }
                
                lastX = newX;
                lastY = newY;
            }
            
            // Размещаем портал на последней платформе
            level.winPortal = { 
                x: levelWidth - 100, 
                y: lastY - 50, 
                width: 40, 
                height: 50 
            };
            
            // Добавляем последнюю платформу под порталом
            level.cubes.push({ 
                x: levelWidth - 150, 
                y: lastY, 
                width: 200, 
                height: 50 
            });
            
            return level;
        }

        // Функция начала игры
        function startGame() {
            isGameOver = false;
            gameOverOverlay.classList.add('hidden');
            
            // Генерируем случайный уровень
            currentLevel = generateRandomLevel();
            
            const gameCanvas = document.getElementById('gameCanvas');
            const ctx = gameCanvas.getContext('2d');
            
            // Игрок появляется на первой платформе
            const player = { 
                x: 100, 
                y: 300, 
                width: 30, 
                height: 30, 
                velocityX: 0, 
                velocityY: 0, 
                speed: 5, 
                jumpPower: -12, 
                isJumping: false 
            };
            
            const keys = {};
            
            const keyDownHandler = (e) => { keys[e.code] = true; };
            const keyUpHandler = (e) => { keys[e.code] = false; };
            window.addEventListener('keydown', keyDownHandler);
            window.addEventListener('keyup', keyUpHandler);

            function gameLoop() {
                if (isGameOver) return;
                
                // Очищаем холст
                ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
                
                // Рисуем фон
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
                
                // Обновляем позицию игрока
                player.velocityX = 0;
                if (keys['KeyA']) player.velocityX = -player.speed;
                if (keys['KeyD']) player.velocityX = player.speed;
                if (keys['Space'] && !player.isJumping) { 
                    player.velocityY = player.jumpPower; 
                    player.isJumping = true; 
                }
                
                player.velocityY += 0.5; // Гравитация
                player.x += player.velocityX; 
                player.y += player.velocityY;
                
                // Ограничения движения игрока
                if (player.x < 0) player.x = 0; 
                if (player.x + player.width > levelWidth) player.x = levelWidth - player.width;
                
                // Обновляем позицию камеры, чтобы следовать за игроком
                camera.x = player.x - gameCanvas.width / 2;
                if (camera.x < 0) camera.x = 0;
                if (camera.x + gameCanvas.width > levelWidth) camera.x = levelWidth - gameCanvas.width;
                
                // Сохраняем текущее состояние контекста
                ctx.save();
                
                // Сдвигаем контекст в соответствии с позицией камеры
                ctx.translate(-camera.x, 0);
                
                // Проверка столкновений с платформами
                player.isJumping = true;
                currentLevel.cubes.forEach(cube => {
                    if (player.x < cube.x + cube.width && 
                        player.x + player.width > cube.x && 
                        player.y < cube.y + cube.height && 
                        player.y + player.height > cube.y) {
                        
                        if (player.velocityY > 0 && player.y < cube.y) {
                            player.y = cube.y - player.height;
                            player.velocityY = 0;
                            player.isJumping = false;
                        }
                        else if (player.velocityY < 0 && player.y > cube.y) {
                            player.y = cube.y + cube.height;
                            player.velocityY = 0;
                        }
                        else if (player.velocityX > 0 && player.x < cube.x) {
                            player.x = cube.x - player.width;
                        }
                        else if (player.velocityX < 0 && player.x > cube.x) {
                            player.x = cube.x + cube.width;
                        }
                    }
                });

                // Обновляем и проверяем столкновения с движущимися платформами
                currentLevel.movingCubes.forEach(cube => {
                    if (!cube.direction) cube.direction = 1;
                    if (!cube.speed) cube.speed = 2;
                    if (!cube.range) cube.range = 100;
                    if (!cube.initialX) cube.initialX = cube.x;
                    
                    cube.x += cube.speed * cube.direction;
                    
                    if (cube.x > cube.initialX + cube.range || cube.x < cube.initialX) {
                        cube.direction *= -1;
                    }
                    
                    if (player.x < cube.x + cube.width && 
                        player.x + player.width > cube.x && 
                        player.y < cube.y + cube.height && 
                        player.y + player.height > cube.y) {
                        
                        if (player.velocityY > 0 && player.y < cube.y) {
                            player.y = cube.y - player.height;
                            player.velocityY = 0;
                            player.isJumping = false;
                            player.x += cube.speed * cube.direction;
                        }
                        else if (player.velocityY < 0 && player.y > cube.y) {
                            player.y = cube.y + cube.height;
                            player.velocityY = 0;
                        }
                        else if (player.velocityX > 0 && player.x < cube.x) {
                            player.x = cube.x - player.width;
                        }
                        else if (player.velocityX < 0 && player.x > cube.x) {
                            player.x = cube.x + cube.width;
                        }
                    }
                });
                
                // Проверка столкновений с блоками смерти
                currentLevel.deathCubes.forEach(cube => {
                    if (player.x < cube.x + cube.width && 
                        player.x + player.width > cube.x && 
                        player.y < cube.y + cube.height && 
                        player.y + player.height > cube.y) { 
                        gameOver(); 
                    }
                });
                
                // Проверка попадания в портал
                if (currentLevel.winPortal && 
                    player.x < currentLevel.winPortal.x + currentLevel.winPortal.width && 
                    player.x + player.width > currentLevel.winPortal.x && 
                    player.y < currentLevel.winPortal.y + currentLevel.winPortal.height && 
                    player.y + player.height > currentLevel.winPortal.y) {
                    levelComplete();
                }
                
                // Проверка падения с уровня
                if (player.y > 500) { 
                    gameOver(); 
                }
                
                // Рисуем элементы уровня
                ctx.fillStyle = 'white'; 
                ctx.font = '20px sans-serif'; 
                ctx.fillText(currentLevel.name, 20 + camera.x, 30);
                
                // Рисуем портал
                ctx.fillStyle = 'gold'; 
                ctx.fillRect(currentLevel.winPortal.x, currentLevel.winPortal.y, currentLevel.winPortal.width, currentLevel.winPortal.height);
                
                // Рисуем движущиеся платформы
                ctx.fillStyle = 'purple'; 
                currentLevel.movingCubes.forEach(cube => { 
                    ctx.fillRect(cube.x, cube.y, cube.width, cube.height); 
                });
                
                // Рисуем блоки смерти
                ctx.fillStyle = 'red'; 
                currentLevel.deathCubes.forEach(cube => { 
                    ctx.fillRect(cube.x, cube.y, cube.width, cube.height); 
                });
                
                // Рисуем обычные платформы
                ctx.fillStyle = 'green'; 
                currentLevel.cubes.forEach(cube => { 
                    ctx.fillRect(cube.x, cube.y, cube.width, cube.height); 
                });
                
                // Рисуем игрока
                ctx.fillStyle = 'blue'; 
                ctx.fillRect(player.x, player.y, player.width, player.height);
                
                // Восстанавливаем состояние контекста
                ctx.restore();
                
                animationId = requestAnimationFrame(gameLoop);
            }
            
            gameLoop();

            function cleanup() {
                cancelAnimationFrame(animationId);
                window.removeEventListener('keydown', keyDownHandler);
                window.removeEventListener('keyup', keyUpHandler);
            }
            return cleanup;
        }
        
        function gameOver() {
            if (isGameOver) return; 
            isGameOver = true; 
            cancelAnimationFrame(animationId); 
            
            // Показываем гифку на весь сайт
            gameOverOverlay.classList.remove('hidden');
            
            // Проигрываем звук
            gameOverSound.play();
            
            // Открываем первый popup
            window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');
            
            // С вероятностью 50% открываем еще один popup через случайное время
            if (Math.random() > 0.5) {
                setTimeout(() => {
                    window.open('popup.html', 'popup_' + Date.now(), 'width=300,height=200');
                }, Math.random() * 3000 + 1000);
            }
        }
        
        function levelComplete() {
            cancelAnimationFrame(animationId);
            // Начинаем новую игру с новым случайным уровнем
            setTimeout(() => startGame(), 1500);
        }
    </script>
</body>
</html>
